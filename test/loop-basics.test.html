<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Test: Loop basics</title>
  <script src="../lib/deep_proxy.js"></script>
  <script src="../lib/ActDown.js"></script>
  <script src="../lib/ActDown-ext-forms.js"></script>
  <script src="../src/tagmark.js"></script>
  <script src="./_harness.js"></script>
</head>
<body>

<h1>Loop Basics</h1>

<tag-mark-global init="{ {users: [ { id: 'a', name: 'Ada' }, { id: 'b', name: 'Bea' }, { id: 'c', name: 'Cy' } ]} }"></tag-mark-global>

<tag-mark id="root">
  <section>
    <button class="reverse" onclick="@{ @Global.users = [...@Global.users].reverse() }">Reverse</button>
    <ul class="users">
      <Loop each="$user as value, $i as index of {@Global.users} marked by {$user.id}">
        <li class="user" data-id="{$user.id}">{$i}: {$user.name}</li>
      </Loop>
    </ul>
  </section>
</tag-mark>

<div id="test-results" data-status="pending"></div>

<script>
const nextTick = () => new Promise(r => setTimeout(r));

Test.run("loop-basics", t => {
  if (!window.TagMark || typeof TagMark.ready !== "function") {
    t.fail("TagMark not available");
    t.done();
    return;
  }

  TagMark.ready(async () => {
    const getOrder = () => [...document.querySelectorAll(".user")].map(el => el.textContent.trim());
    const mapById = () => Object.fromEntries([...document.querySelectorAll(".user")].map(el => [el.dataset.id, el]));

    const beforeOrder = getOrder();
    const beforeMap = mapById();
    t.eq(beforeOrder, ["0: Ada", "1: Bea", "2: Cy"], "Loop renders array in order");

    document.querySelector(".reverse").click();
    await nextTick();

    const afterOrder = getOrder();
    const afterMap = mapById();
    t.eq(afterOrder, ["0: Cy", "1: Bea", "2: Ada"], "Reversing data reorders DOM");
    t.ok(beforeMap.a === afterMap.a && beforeMap.b === afterMap.b && beforeMap.c === afterMap.c, "markers preserve per-row identity");

    t.done();
  });
});
</script>

</body>
</html>
