<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Test: def and import scoping</title>
  <script>
    window.addTwo = (a, b) => a + b;
    window.decorate = v => `decorated-${v}`;
  </script>
  <script src="../lib/deep_proxy.js"></script>
  <script src="../lib/ActDown.js"></script>
  <script src="../lib/ActDown-ext-forms.js"></script>
  <script src="../src/tagmark.js"></script>
  <script src="./_harness.js"></script>
</head>
<body>

<h1>Declarations and Imports</h1>

<tag-mark id="root">
  <!-- Use 'as local' + init for state, then alias in nested scope -->
  <section def="@Section as local, $base := {42}" init="{ {user: {name: 'Ada'}} }">
    <p class="outer" import="decorate">Base: {$base} / {decorate($base)}</p>
    <div class="inner" def="$base := {7}, @alias := @Section.user" import="addTwo,decorate">
      <span class="inner-value">{$base}</span>
      <span class="calc">{addTwo($base, 1)}</span>
      <span class="label">{decorate($base)}</span>
      <span class="alias">{@alias.name}</span>
    </div>
  </section>
</tag-mark>

<div id="test-results" data-status="pending"></div>

<script>
Test.run("declarations-and-imports", t => {
  if (!window.TagMark || typeof TagMark.ready !== "function") {
    t.fail("TagMark not available");
    t.done();
    return;
  }

  TagMark.ready(() => {
    t.eq(document.querySelector(".outer")?.textContent.trim(), "Base: 42 / decorated-42", "outer scope uses outer bindings");
    t.eq(document.querySelector(".inner-value")?.textContent.trim(), "7", "inner scope shadows base constant");
    t.eq(document.querySelector(".calc")?.textContent.trim(), "8", "imported helper accessible in inner scope");
    t.eq(document.querySelector(".label")?.textContent.trim(), "decorated-7", "import works with shadowed value");
    t.eq(document.querySelector(".alias")?.textContent.trim(), "Ada", "handle alias uses declared handle");
    t.done();
  });
});
</script>

</body>
</html>
