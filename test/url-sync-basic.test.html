<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Test: URL sync basic</title>
  <script>
    // Seed initial hash
    location.hash = "#foo=hi&count=2";
  </script>
  <script src="../lib/deep_proxy.js"></script>
  <script src="../lib/ActDown.js"></script>
  <script src="../lib/ActDown-ext-forms.js"></script>
  <script src="../src/tagmark.js"></script>
  <script src="./_harness.js"></script>
</head>
<body>

<h1>URL Sync Basic</h1>

<tag-mark id="root">
  <URL include="foo, count"></URL>
  <section>
    <div class="foo">{@Url.foo}</div>
    <div class="count">{@Url.count}</div>
    <button class="set" onclick="@{ (@Url.foo = 'bye', @Url.count = Number(@Url.count || 0) + 1) }">Update URL</button>
  </section>
</tag-mark>

<div id="test-results" data-status="pending"></div>

<script>
const nextTick = () => new Promise(r => setTimeout(r));

Test.run("url-sync-basic", t => {
  if (!window.TagMark || typeof TagMark.ready !== "function") {
    t.fail("TagMark not available");
    t.done();
    return;
  }

  TagMark.ready(async () => {
    t.eq(document.querySelector(".foo")?.textContent.trim(), "hi", "@Url reads initial hash state");
    t.eq(document.querySelector(".count")?.textContent.trim(), "2", "numeric string preserved from hash");

    document.querySelector(".set")?.click();
    await nextTick();

    t.ok(location.hash.includes("foo=bye"), "setting @Url updates hash");
    t.ok(location.hash.includes("count=3"), "incremented count reflected in hash");

    t.done();
  });
});
</script>

</body>
</html>
