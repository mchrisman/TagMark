<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Test: When conditional rendering</title>
  <script src="../lib/deep_proxy.js"></script>
  <script src="../lib/ActDown.js"></script>
  <script src="../lib/ActDown-ext-forms.js"></script>
  <script src="../src/tagmark.js"></script>
  <script src="./_harness.js"></script>
</head>
<body>

<h1>When Conditional</h1>

<tag-mark-global init="{ {show: true, counter: 0} }"></tag-mark-global>

<tag-mark id="root">
  <section>
    <button class="toggle" onclick="@{ @Global.show = !@Global.show }">Toggle</button>
    <button class="increment" onclick="@{ @Global.counter = (@Global.counter || 0) + 1 }">Count</button>
    <When test="{@Global.show}">
      <div class="visible">Visible {@Global.counter}</div>
    </When>
    <Else>
      <div class="hidden">Hidden</div>
    </Else>
  </section>
</tag-mark>

<div id="test-results" data-status="pending"></div>

<script>
const nextTick = () => new Promise(r => setTimeout(r));

Test.run("when-conditional", t => {
  if (!window.TagMark || typeof TagMark.ready !== "function") {
    t.fail("TagMark not available");
    t.done();
    return;
  }

  TagMark.ready(async () => {
    const toggle = document.querySelector(".toggle");
    const increment = document.querySelector(".increment");

    const visible = () => document.querySelector(".visible");
    const hidden = () => document.querySelector(".hidden");

    t.ok(!!visible() && !hidden(), "truthy branch renders initially");

    increment.click();
    increment.click();
    await nextTick();
    t.eq(visible()?.textContent.trim(), "Visible 2", "state updates while visible");

    toggle.click();
    await nextTick();
    t.ok(!visible() && !!hidden(), "else branch renders when false");

    toggle.click();
    await nextTick();
    t.eq(visible()?.textContent.trim(), "Visible 2", "state persists across toggles");

    t.done();
  });
});
</script>

</body>
</html>
