<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Test: Loop duplicate key error</title>
  <script src="../lib/deep_proxy.js"></script>
  <script src="../lib/ActDown.js"></script>
  <script src="../lib/ActDown-ext-forms.js"></script>
  <script src="../src/tagmark.js"></script>
  <script src="./_harness.js"></script>
</head>
<body>

<h1>Loop Duplicate Key Error</h1>

<tag-mark-global init="{ {items: [{id: 'dup', label: 'One'}, {id: 'dup', label: 'Two'}]} }"></tag-mark-global>

<tag-mark id="root">
  <ul>
    <Loop each="$item as value of {@Global.items} marked by {$item.id}">
      <li>{$item.label}</li>
    </Loop>
  </ul>
</tag-mark>

<div id="test-results" data-status="pending"></div>

<script>
Test.run("loop-duplicate-key-error", t => {
  if (!window.TagMark || typeof TagMark.ready !== "function") {
    t.fail("TagMark not available");
    t.done();
    return;
  }

  // Error is thrown during bootstrap, before ready() runs.
  // Since bootstrap failed, the tag-mark element should be empty.
  // The test runner captures "Page error" separately.
  setTimeout(() => {
    const root = document.getElementById("root");
    const listItems = document.querySelectorAll("li");
    // If error was thrown, no list items should render
    t.eq(listItems.length, 0, "duplicate marker prevents rendering");
    t.done();
  }, 50);
});
</script>

</body>
</html>
